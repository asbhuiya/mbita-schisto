---
title: "Mbita, Kenya schistosomiasis study. Analysis of distance from Lake Victoria"
output:
  html_document:
    highlight: haddock
    theme: default
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---


# Preamble
```{r preamble}
library(here)
here()
#--------------------------------
# source the configuration file
#--------------------------------
source(here("R/mbita-schisto-Config.R"))

#--------------------------------
# source the shared functions file
#--------------------------------
source(here("R/mbita-schisto-Functions.R"))

```



# Load Mbita Kenya antibody measurements and other data

These data include measurements from pre-school aged children in 30 villages near Homa Bay and Mbita in Western Kenya. This article summarizes the study design and field methods:

Won KY, Kanyi HM, Mwende FM, Wiegand RE, Brook Goodhew E, Priest JW, et al. Multiplex Serologic Assessment of Schistosomiasis in Western Kenya: Antibody Responses in Preschool Age Children as a Measure of Reduced Transmission. _Am J Trop Med Hyg._ 2017; 16â€“0665. https://www.ncbi.nlm.nih.gov/pubmed/28719280

```{r load data, warning=FALSE}
#-----------------------------------
# load the child antibody and 
# kato-katz measurements
#-----------------------------------
d <- readRDS(here("data","mbita_schisto.rds")) %>%
  mutate(vid=factor(vid))

#-----------------------------------
# load the village-level spatial
# covariate data, created with
# mbita-schisto-map.Rmd
#
# note: for public-facing workflow
# this file does not include village 
# lon/lat to protect participant
# confidentiality
#-----------------------------------
d_spatial <- readRDS(here("data","mbita_spatial.rds")) %>%
  mutate(vid=factor(vid))

d2 <- d %>%
  left_join(d_spatial,by="vid")

# create age strata
# create log values for SEA MFI and KK epg
# convert the dist_victoria variable from class units to numeric
# add a dummy variable for modeling
d2 <- d2 %>%
  mutate(agecat = cut(agey,breaks=c(0,1,2,3,4,6),
                      labels=c("<1 year","1 year","2 years","3 years","4 years")),
         logsea = log10(sea),
         logepg = log10(sm_epg),
         dist_victoria = as.numeric(dist_victoria),
         dummy=1
         )

#-----------------------------------
# load village-level FOI estimates
# estimated in the notebook
# mbita-schisto-SEA-vs_KK.Rmd
#-----------------------------------
d_foi <- readRDS(here("output","mbita-village-foi.rds"))

#-----------------------------------
# create a village-level summary
# dataset of spatial covariates,
# prevalence, and FOI for making figures
#-----------------------------------

dvil <- d2 %>%
  group_by(vid) %>%
  summarize(sea_n = sum(sea_pos,na.rm=T),
            sea_N = sum(ifelse(!is.na(sea_pos),1,0)),
            kk_n = sum(kk_pos,na.rm=T),
            kk_N = sum(ifelse(!is.na(kk_pos),1,0)),
            arm = max(arm)
            ) %>%
  mutate(sea_prev = sea_n/sea_N,
         kk_prev = kk_n/kk_N)
  
# join FOI estimates
dvil2 <- left_join(dvil,d_foi,by="vid")

# join spatial covariates
dvil3 <- left_join(dvil2,d_spatial,by="vid") %>%
  mutate(dist_victoria = as.numeric(dist_victoria))

```


# Village-level seroprevalence and FOI versus distance from the lake

## Fit models of prevalence by distance

Estimate seroprevalence as a function of distance from Lake Victoria using a semi-parametric spline, adjust for age

```{r seroprevalence vs dist}
#-----------------------------
# spline model of SEA seroprevalence
# by distance from the lake
# 
# include village-level random
# effects to account for within-
# village correlation
#
# limit predictions to within
# 4km of the lake to reduce
# edge effects from the single
# village that is beyond
#-----------------------------

fit_sea_dist <- mgcv::gam(sea_pos~s(dist_victoria,bs="cr",k=4) +  s(vid,bs="re",by=dummy),
                          family="binomial",
                          data=d2)

newd <- d2 %>%  
  group_by(vid) %>%
  filter(dist_victoria < 4000) %>%
  slice(1) %>%
  mutate(dummy=0)
fit_sea_dist_ci <- gamCI(m=fit_sea_dist,newdata=newd,nreps=10000)

# convert linear predictor to prevalance 
# (note: expitfn() is in shared functions, source above)
fit_sea_dist_ci <- fit_sea_dist_ci %>%
  mutate(fit = expitfn(fit),
         uprP = expitfn(uprP),
         lwrP = expitfn(lwrP),
         uprS = expitfn(uprS),
         lwrS = expitfn(lwrS),
         )

```

Estimate Kato-Katz prevalence as a function of distance from Lake Victoria using a semi-parametric spline

```{r kk prevalence vs dist}
#-----------------------------
# spline model of SEA seroprevalence
# by distance from the lake
#-----------------------------

fit_kk_dist <- mgcv::gam(kk_pos~s(dist_victoria,bs="cr",k=4) + s(vid,bs="re",by=dummy), 
                         family="binomial",
                         data=d2)

newd <- d2 %>% 
  group_by(vid) %>%
  slice(1) %>%
  mutate(dummy=0)
fit_kk_dist_ci <- gamCI(m=fit_kk_dist,newdata=newd,nreps=10000)

# convert linear predictor to prevalance 
# (note: expitfn() is in shared functions, source above)
fit_kk_dist_ci <- fit_kk_dist_ci %>%
  mutate(fit = expitfn(fit),
         uprP = expitfn(uprP),
         lwrP = expitfn(lwrP),
         uprS = expitfn(uprS),
         lwrS = expitfn(lwrS),
         )
```


## KK prevalence vs. distance

```{r KK prev vs distance fig}
#-----------------------------
# KK prevalence by distance
#-----------------------------
pkkdist <- ggplot(data=fit_kk_dist_ci,aes(x=dist_victoria/1000)) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  geom_point(data=dvil3,aes(x=dist_victoria/1000,y=kk_prev),alpha=1,color=cbPalette[2]) +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,0.6),xlim=c(0,5)) +
  labs(x="distance from lake Victoria (km)",y="community prevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")
pkkdist

```

## SEA seroprevalence vs. distance
```{r SEA seroprev vs distance fig}
#-----------------------------
# SEA seroprevalence by distance
#
# color village points by <1500
# and >1500m from the lake
# to match age-stratified
# curve figure aesthetics
#-----------------------------
pspdist <- ggplot(data=fit_sea_dist_ci,aes(x=dist_victoria/1000)) +
  # approximate simultaneous confidence interval for the spline fit
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  # spline fit
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # village means, <1500 m
  geom_point(data=filter(dvil3,dist_victoria<1500),aes(x=dist_victoria/1000,y=sea_prev),alpha=1,color=cbPalette[8]) +
  # village means, >1500 m
  geom_point(data=filter(dvil3,dist_victoria>=1500),aes(x=dist_victoria/1000,y=sea_prev),alpha=1,color=cbPalette[4]) +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,1),xlim=c(0,5)) +
  labs(x="distance from Lake Victoria (km)",y="community seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")
pspdist

# save png file
ggsave(filename=here("output","mbita-SEA-seroprev-v-dist.png"),plot=pspdist,device="png",width=3*1.18,height=3)

```

## SEA FOI vs. distance
```{r SEA FOI vs distance fig}
#-----------------------------
# FOI measured by SEA seroconversion over by distance
#-----------------------------
pfoidist <- ggplot(data=dvil3,aes(x=dist_victoria/1000,y=lambda,ymin=lambda_lb,ymax=lambda_ub)) +
  # village mean FOI for villages <1500m
  # geom_point(data=filter(dvil3,dist_victoria<1500),alpha=1,color=cbPalette[8]) +
  geom_pointrange(data=filter(dvil3,dist_victoria<1500),alpha=1,color=cbPalette[8]) +
  # village mean FOI for villages >1500m
  # geom_point(data=filter(dvil3,dist_victoria>=1500),alpha=1,color=cbPalette[4]) +
  geom_pointrange(data=filter(dvil3,dist_victoria>=1500),alpha=1,color=cbPalette[4]) +
  scale_y_continuous(breaks=seq(0,0.8,by=0.2))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,0.8),xlim=c(0,5)) +
  labs(x="distance from Lake Victoria (km)",y=expression(paste("community level force of infection (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="none")
pfoidist

# save png file
ggsave(filename=here("output","mbita-SEA-foi-v-dist.png"),plot=pfoidist,device="png",width=3*1.18,height=3)
```



# Repeat figures, colored by intervention arm

Repeat the figures above, coloring the points by intervention arm to ensure the patterns are not driven by community-level versus school-based praziquantle distribution

```{r KK prev vs distance colored by arm fig}
#-----------------------------
# KK prevalence by distance
# points colored by intervention arm
#-----------------------------
pkkdist2 <- ggplot(data=fit_kk_dist_ci,aes(x=dist_victoria/1000,color=arm)) +
  geom_point(data=dvil3,aes(x=dist_victoria/1000,y=kk_prev),alpha=0.9) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=cbPalette[c(4,8)])+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community prevalence (%)") +
  theme_minimal() +
  theme(legend.position="right")
pkkdist2
```

```{r SEA seroprev vs distance colored by arm fig}
#-----------------------------
# SEA seroprevalence by distance
# points colored by intervention arm
#-----------------------------
pspdist2 <- ggplot(data=fit_sea_dist_ci,aes(x=dist_victoria/1000,color=arm)) +
  geom_point(data=dvil3,aes(x=dist_victoria/1000,y=sea_prev),alpha=0.9) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=cbPalette[c(4,8)])+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="right")
pspdist2
```


```{r SEA FOI vs distance colored by arm fig}
#-----------------------------
# FOI measured by SEA seroconversion over by distance
# points colored by intervention arm
#-----------------------------
pfoidist2 <- ggplot(data=dvil3,aes(x=dist_victoria/1000,y=lambda,color=arm)) +
  geom_point(alpha=0.9) +
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=cbPalette[c(4,8)])+
  coord_cartesian(ylim=c(0,0.65),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="right")
pfoidist2
```

# Cumulative cases identified by distance from the lake

Summarize the cumulative number of Kato-Katz positive infections and seropositive children by distance to Lake Victoria.

Note that these curves are influenced by different village sizes, and are not normalized to remove the influence of village size.

They do provide estimates, within this study, of the proportion of infected children identified with different distances from the lake.  

As a comparison, we also estimated the proportion of positivies identified by ranking villages by cases and by prevalence, which provide an upper bound of the optimal ranking of villages to identify infected children.



```{r cumulative kk cases by distance}
dkkcum <- dvil3 %>%
  dplyr::select(vid, dist_victoria, kk_N, kk_n, kk_prev) 

dkkdist <- dkkcum %>%
  arrange(dist_victoria) %>%
  mutate(vil_rank = row_number(),
         n_tot = sum(kk_n),
         n_cum = cumsum(kk_n),
         p_cum = n_cum / n_tot,
         sorted = "distance") %>%
  dplyr::select(sorted,vid,dist_victoria,kk_prev,vil_rank,n_cum,p_cum)

dkkprev <- dkkcum %>%
  arrange(-kk_prev) %>%
  mutate(vil_rank = row_number(),
         n_tot = sum(kk_n),
         n_cum = cumsum(kk_n),
         p_cum = n_cum / n_tot,
         sorted = "prevalence") %>%
  dplyr::select(sorted,vid,dist_victoria,kk_prev,vil_rank,n_cum,p_cum)

dkkcumd <- bind_rows(dkkdist,dkkprev) %>%
  mutate(sorted = factor(sorted,levels = c("prevalence", "distance")),
         outcome = "Kato-Katz"
         )

dkkn <- dkkcum %>%
  arrange(-kk_n) %>%
  mutate(vil_rank = row_number(),
         n_tot = sum(kk_n),
         n_cum = cumsum(kk_n),
         p_cum = n_cum / n_tot,
         sorted = "cases") %>%
  dplyr::select(sorted,vid,dist_victoria,kk_prev,vil_rank,n_cum,p_cum)

dkkcumd <- bind_rows(dkkdist,dkkprev,dkkn) %>%
  mutate(sorted = factor(sorted,levels = c("cases","prevalence", "distance")),
         outcome = "Kato-Katz"
         )

```


```{r cumulative sea positive by distance}
dseacum <- dvil3 %>%
  dplyr::select(vid, dist_victoria, sea_N, sea_n, sea_prev) 

dseadist <- dseacum %>%
  arrange(dist_victoria) %>%
  mutate(vil_rank = row_number(),
         n_tot = sum(sea_n),
         n_cum = cumsum(sea_n),
         p_cum = n_cum / n_tot,
         sorted = "distance") %>%
  dplyr::select(sorted,vid,dist_victoria,sea_prev,vil_rank,n_cum,p_cum)

dseaprev <- dseacum %>%
  arrange(-sea_prev) %>%
  mutate(vil_rank = row_number(),
         n_tot = sum(sea_n),
         n_cum = cumsum(sea_n),
         p_cum = n_cum / n_tot,
         sorted = "prevalence") %>%
  dplyr::select(sorted,vid,dist_victoria,sea_prev,vil_rank,n_cum,p_cum)

dsean <- dseacum %>%
  arrange(-sea_n) %>%
  mutate(vil_rank = row_number(),
         n_tot = sum(sea_n),
         n_cum = cumsum(sea_n),
         p_cum = n_cum / n_tot,
         sorted = "cases") %>%
  dplyr::select(sorted,vid,dist_victoria,sea_prev,vil_rank,n_cum,p_cum)


dseacumd <- bind_rows(dseadist,dseaprev,dsean) %>%
  mutate(sorted = factor(sorted,levels = c("cases","prevalence", "distance")),
         outcome = "SEA"
  )

```

```{r combine cumulative estimates}
dcum <- bind_rows(dkkcumd, dseacumd)

```


## Figures

Cumulative number of positives stratified by measure (Kato Katz, SEA)

```{r cumulative cases by distance figure}

pcols <- cbPalette[c(4,6,8)]
pcumdist <- ggplot(data=dcum, aes(x = vil_rank, y = p_cum, color = sorted)) +
  facet_grid(.~outcome) + 
  geom_abline(intercept = 0, slope = 1/30, color = "gray40")+
  geom_line() +
  scale_color_manual(values = pcols, guide = guide_legend(title = "Ranking")) +
  labs(x = "Villages ranked by cases, prevalence or distance", y = "cumulative proportion of children positive") +
  theme(
    legend.position = c(0.9,0.2)
  )

pcumdist

```

Cumulative number of positives stratified by ranking approach (cases, prevalence, distance)

```{r cumulative cases by distance figure2}

pcols <- cbPalette[c(7,6)]
pcumdist2 <- ggplot(data=dcum, aes(x = vil_rank, y = p_cum, color = outcome)) +
  facet_grid(.~sorted) + 
  geom_abline(intercept = 0, slope = 1/30, color = "gray40")+
  geom_line() + 
  scale_color_manual(values = pcols, guide = guide_legend(title = "Measure")) +
  labs(x = "Villages ranked by cases, prevalence or distance", y = "cumulative proportion of children positive") +
  theme(
    legend.position = c(0.9,0.2)
  )

pcumdist2

```

## Print estimates for reporting in the manuscript

```{r cumulative case table kk}
cum_kk_tab <- dcum %>% 
  filter(outcome=="Kato-Katz" & sorted == "distance") %>% 
  dplyr::select(vil_rank,dist_victoria,kk_prev,n_cum,p_cum)


knitr::kable(cum_kk_tab,digits = 3) %>%
  kable_styling(bootstrap_options = "striped")

```


```{r cumulative case table sea}
cum_sea_tab <- dcum %>% 
  filter(outcome=="SEA" & sorted == "distance") %>% 
  dplyr::select(vil_rank,dist_victoria,sea_prev,n_cum,p_cum)

knitr::kable(cum_sea_tab,digits = 3) %>%
  kable_styling(bootstrap_options = "striped")

```

# Session Info
```{r session info}
sessionInfo()
```


