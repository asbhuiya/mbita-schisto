---
title: "Mbita, Kenya schistosomiasis study. Estimating force of infection from antibody response"
output:
  html_document:
    highlight: haddock
    theme: default
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---


# Preamble
```{r preamble}
library(here)
here()
#--------------------------------
# source the configuration file
#--------------------------------
source(here("R/mbita-schisto-Config.R"))
```



# Load Mbita Kenya antibody measurements

These data include measurements from pre-school aged children in 30 villages near Homa Bay and Mbita in Western Kenya. This article summarizes the study design and field methods:

Won KY, Kanyi HM, Mwende FM, Wiegand RE, Brook Goodhew E, Priest JW, et al. Multiplex Serologic Assessment of Schistosomiasis in Western Kenya: Antibody Responses in Preschool Age Children as a Measure of Reduced Transmission. _Am J Trop Med Hyg._ 2017; 16–0665. https://www.ncbi.nlm.nih.gov/pubmed/28719280

```{r load data, warning=FALSE}
#-----------------------------------
# load the child antibody and 
# kato-katz measurements
#-----------------------------------
d <- readRDS(here("data","mbita_schisto.rds"))

#-----------------------------------
# load the village-level spatial
# covariate data, created with
# mbita-schisto-map.Rmd
#
# note: for public-facing workflow
# this file does not include village 
# lon/lat to protect participant
# confidentiality
#-----------------------------------
d_spatial <- readRDS(here("data","mbita_spatial.rds"))

d2 <- d %>%
  left_join(d_spatial,by="vid")

# create age strata
# create log values for SEA MFI and KK epg
# convert the dist_victoria variable from class units to numeric
d2 <- d2 %>%
  mutate(agecat = cut(agey,breaks=c(0,1,2,3,4,6),
                      labels=c("<1 year","1 year","2 years","3 years","4 years")),
         logsea = log10(sea),
         logepg = log10(sm_epg),
         dist_victoria = as.numeric(dist_victoria)
         )

```


# Age stratified distributions

```{r density plot by age}

table(d2$agecat)

pdist <- ggplot(data=d2,aes(x=logsea)) +
  facet_grid(agecat~.) +
  geom_density(alpha=1,color=NA,fill=cbPalette[3]) +
  geom_vline(aes(xintercept = log10(965) ),lty=1) +
  # scale_fill_manual(values=pcols)+
  # geom_vline(aes(xintercept = mixcut),lty=2) +
  labs(x="log10 luminex response (MFI-bg)") +
  theme_minimal() + 
  theme(legend.position = "none",
        strip.text.y=element_text(angle=0))

pdist

# save png file for presentation
# ggsave(filename=here("output","mbita-ab-dists-ashb-sea-vsp.png"),plot=pdist2,device="png",width=8,height=7)

```


# Age dependent seroprevalence

## Function for a simultaneous CI around a spline curve
```{r simultaneous CI}
#----------------------------------
# simulataneous CIs for GAMs
# estimated by resampling the 
# Baysian posterior estimates of
# the variance-covariance matrix
# assuming that it is multivariate normal
# the function below also estimates 
# the unconditional variance-covariance
# matrix, Vb=vcov(x,unconditional=TRUE), 
# which allows for undertainty in the actual
# estimated mean as well 
# (Marra & Wood 2012 Scandinavian Journal of Statistics, 
#  Vol. 39: 53–74, 2012, doi: 10.1111/j.1467-9469.2011.00760.x )
# simultaneous CIs provide much better coverage than pointwise CIs
# see: http://www.fromthebottomoftheheap.net/2016/12/15/simultaneous-interval-revisited/
#----------------------------------

gamCI <- function(m,newdata,nreps=10000) {
  require(mgcv)
  require(dplyr)
  Vb <- vcov(m,unconditional = TRUE)
  pred <- predict(m, newdata, se.fit = TRUE)
  fit <- pred$fit
  se.fit <- pred$se.fit
  BUdiff <- MASS::mvrnorm(n=nreps, mu = rep(0, nrow(Vb)), Sigma = Vb)
  Cg <- predict(m, newdata, type = "lpmatrix")
  simDev <- Cg %*% t(BUdiff)
  absDev <- abs(sweep(simDev, 1, se.fit, FUN = "/"))
  masd <- apply(absDev, 2L, max)
  crit <- quantile(masd, prob = 0.95, type = 8)
  pred <- data.frame(newdata,fit=pred$fit,se.fit=pred$se.fit)
  pred <- mutate(pred,
                 uprP = fit + (2 * se.fit),
                 lwrP = fit - (2 * se.fit),
                 uprS = fit + (crit * se.fit),
                 lwrS = fit - (crit * se.fit)
  )
  return(pred)
}

```

## Age dependent seroprevalence
```{r agecurves seroprev}
#----------------------------------
# prep data for spline fits
#----------------------------------
d3 <- d2 %>% 
  ungroup() %>%
  mutate(vid=factor(vid),
         dummy=1)

# Schisto SEA
fitp_sea <- mgcv::gam(sea_pos~s(agey,bs="cr",k=9) + s(vid,bs="re",by=dummy), family="binomial", 
                      data=d3)
newd <- d3 %>%  mutate(dummy=0)
fitp_seaci <- gamCI(m=fitp_sea,newdata=newd,nreps=10000)


# convert linear predictor to prevalance
expitfn <- function(x) {
  exp(x)/(1+exp(x))
}
fitp_seaci <- fitp_seaci %>%
  mutate(fit = expitfn(fit),
         uprP = expitfn(uprP),
         lwrP = expitfn(lwrP),
         uprS = expitfn(uprS),
         lwrS = expitfn(lwrS),
         )

```

```{r seroprev by age plot}

pageprev <- ggplot(data=fitp_seaci,aes(x=agey,y=fit)) +
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill="black") +
  geom_line(lwd=0.5,alpha=1,color=cbPalette[3]) +
  # geom_smooth(method="loess",se=FALSE,lwd=0.5) +
  # scale_color_manual(values=pcols)+
  scale_y_continuous(breaks=seq(0,0.8,by=0.1),labels=seq(0,80,by=10))+
  labs(x="age, years",y="SEA seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")

pageprev


```




# Estimate village-level FOI

## Constant rate model
Estimate community-level FOI for pathogens based on the seroconversion rate (incidence among susceptibles). Assume a constant rate model (i.e., average over all ages).  If we assume a constant force of infection ($\lambda$), equivalent to assuming an exponential model, then it can be shown that a generalized linear model with a complementary log-log link fit with current status, age-prevalence data is equivalent to an exponential proportional hazards model (*Jewell and van der Laan 1995*). 

$\log - \log(1-P(Y|A,W)) = \log \lambda + \log A + \beta W$

Moroever, this model is also equivalent to a catalytic, SIR model with a single, constant rate parameter (*Hens et al. 2010*; *Hens et al. 2012*).

```{r  foi from exponential model}

# foi_ests <- foreach(ai=c("S. mansoni SEA","P. falciparum MSP-1"),.combine=rbind) %:%
foi_ests <- foreach(comi=levels(d3$vid),.combine=rbind) %dopar% {
  di <- d3 %>% filter(vid==comi)
  gfit <- glm(sea_pos~1,offset=log(agey),data=di,family=binomial(link="cloglog"))
  gsum <- summary(gfit)
  lambda <- as.numeric(exp(gfit$coefficients))
  log_lambda_se  <- sqrt(gsum$cov.unscaled)
  lambda_lb <- as.numeric(exp(gfit$coefficients - 1.96*log_lambda_se))
  lambda_ub <- as.numeric(exp(gfit$coefficients + 1.96*log_lambda_se))
  res <- data.frame(vid=comi,lambda,lambda_lb,lambda_ub)
  return(res)
}

foi_ests

```

## Comparison of village level estimates

```{r cluster means vs kk}

d3c <- d3 %>%
  group_by(vid) %>%
  mutate(nsea = ifelse(is.na(sea_pos),0,1),
         nkk = ifelse(is.na(kk_pos),0,1)
         ) %>%
  summarize(arm = max(arm),
            nsea = sum(nsea),
            meansea = mean(logsea),
            prevsea = mean(sea_pos),
            nkk = sum(nkk),
            meankk = mean(ifelse(logepg<0,1,logepg),na.rm=T),
            prevkk = mean(kk_pos,na.rm=T),
            elev = max(elev),
            tmin = max(tmin),
            prec = max(prec),
            dist_victoria = as.numeric(max(dist_victoria))
            ) 


# merge in FOI estimates
d3c <- d3c %>%
  left_join(foi_ests,by=c("vid"))



# # estimate pearson correlation
dcorrkk <- d3c %>%
  mutate(corspkk=cor(prevsea,prevkk,method="spearman"),
         cormukk=cor(meansea,prevkk,method="spearman"),
         corpseakkmu=cor(prevsea,meankk,method="spearman"),
         cormukkfoi=cor(lambda,meankk,method="spearman"),
         corpkkfoi=cor(lambda,prevkk,method="spearman")) %>%
  slice(1)


sp_epg_plot <- ggplot(data=d3c,aes(x=meankk,y=prevsea)) +
  geom_point(color=cbPalette[3],alpha=0.9) +
  geom_smooth(method="loess",se=FALSE,color="black",lwd=0.5) +
  scale_y_continuous(breaks=seq(0,1,by=0.1),labels=sprintf("%1.0f",seq(0,1,by=0.1)*100))+
  coord_cartesian(ylim=c(0,1),xlim=c(1.0,1.5))+
  labs(x="",y="SEA seroprevalence (%)") +
  theme(panel.grid.minor.y=element_blank())

foi_epg_plot <- ggplot(data=d3c,aes(x=meankk,y=lambda)) +
  geom_point(color=cbPalette[3],alpha=0.9) +
  geom_smooth(method="loess",se=FALSE,color="gray40",lwd=0.25) +
  geom_smooth(method="glm",se=FALSE,color="black",lwd=0.5) +
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  coord_cartesian(ylim=c(0,0.65),xlim=c(1.0,1.5))+
  labs(x="mean log10 S. mansoni eggs per gram",y=expression(paste("force of infection (",lambda,"), seroconversion rate per year")) ,eval=TRUE)


vil_trans_plots <- grid.arrange(sp_epg_plot,foi_epg_plot,nrow=2,ncol=1)

ggsave(filename=here("output","mbita-village-transmission-ests.png"),plot=vil_trans_plots,device="png",width=4,height=8)

```

## Village-level seroprevalence and FOI versus distance from the lake


```{r seroprevalence vs dist}
#-----------------------------
# spline model of SEA seroprevalence
# by distance from the lake
#-----------------------------

fit_sea_dist <- mgcv::gam(sea_pos~s(dist_victoria,bs="cr",k=4) + s(vid,bs="re",by=dummy), 
                      data=d3)
newd <- d3 %>% filter(dist_victoria < 4000) %>% mutate(dummy=0)
fit_sea_dist_ci <- gamCI(m=fit_sea_dist,newdata=newd,nreps=10000)

```

```{r kk prevalence vs dist}
#-----------------------------
# spline model of SEA seroprevalence
# by distance from the lake
#-----------------------------

fit_kk_dist <- mgcv::gam(kk_pos~s(dist_victoria,bs="cr",k=4) + s(vid,bs="re",by=dummy), 
                      data=d3)
newd <- d3 %>% filter(dist_victoria < 4000) %>% mutate(dummy=0)
fit_kk_dist_ci <- gamCI(m=fit_kk_dist,newdata=newd,nreps=10000)

```

```{r figures of village estimates by distance from lake}

#-----------------------------
# SEA seroprevalence by distance
#-----------------------------
pspdist <- ggplot(data=fit_sea_dist_ci,aes(x=dist_victoria/1000)) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  geom_point(data=d3c,aes(x=dist_victoria/1000,y=prevsea),alpha=1,color=cbPalette[3]) +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")
pspdist

#-----------------------------
# SEA seroprevalence by distance
# points colored by intervention arm
#-----------------------------
pspdist2 <- ggplot(data=fit_sea_dist_ci,aes(x=dist_victoria/1000,color=arm)) +
  geom_point(data=d3c,aes(x=dist_victoria/1000,y=prevsea),alpha=0.9) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=cbPalette[c(4,8)])+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="right")
pspdist2


#-----------------------------
# KK prevalence by distance
#-----------------------------
pkkdist <- ggplot(data=fit_kk_dist_ci,aes(x=dist_victoria/1000)) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  geom_point(data=d3c,aes(x=dist_victoria/1000,y=prevkk),alpha=1,color=cbPalette[2]) +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community prevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")
pkkdist

#-----------------------------
# SEA seroprevalence by distance
# points colored by intervention arm
#-----------------------------
pkkdist2 <- ggplot(data=fit_kk_dist_ci,aes(x=dist_victoria/1000,color=arm)) +
  geom_point(data=d3c,aes(x=dist_victoria/1000,y=prevkk),alpha=0.9) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=cbPalette[c(4,8)])+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community prevalence (%)") +
  theme_minimal() +
  theme(legend.position="right")
pkkdist2


#-----------------------------
# FOI measured by SEA seroconversion over by distance
#-----------------------------
pfoidist <- ggplot(data=d3c,aes(x=dist_victoria/1000,y=lambda)) +
  geom_point(alpha=0.9,color=cbPalette[3]) +
  # geom_vline(xintercept = 1.5, lty = "dashed") +
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,0.65),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="none")
pfoidist

#-----------------------------
# FOI measured by SEA seroconversion over by distance
# points colored by intervention arm
#-----------------------------
pfoidist2 <- ggplot(data=d3c,aes(x=dist_victoria/1000,y=lambda,color=arm)) +
  geom_point(alpha=0.9) +
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=cbPalette[c(4,8)])+
  coord_cartesian(ylim=c(0,0.65),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="right")
pfoidist2


# save png file for presentation
# ggsave(filename=here("output","mbita-prev-v-dist.png"),plot=pspdist,device="png",width=3*1.18,height=3)


```

# LEFT OFF HERE ############################

```{r merge foi estimates}
# merge FOI estimates to the cluster-level means
d_foi <- dlc %>%
  # filter(antigenf=="S. mansoni SEA"|antigenf=="P. falciparum MSP-1") %>%
  left_join(foi_ests,by=c("vid","antigenf"))# %>%
  # mutate(antigenf=factor(antigenf,levels=c("S. mansoni SEA","P. falciparum MSP-1")))


# estimate spearman correlation
dfoicorr <- d_foi %>%
  ungroup() %>%
  group_by(antigenf) %>%
  mutate(cormfi=cor(meanmfi,lambda,method="spearman"),
         corprev=cor(prevroc,lambda,method="spearman")) %>%
  slice(1)

```

Figure of results

```{r foi vs prev figure}
pfoivprev <- ggplot(data=d_foi,aes(x=prevroc,y=lambda,color=antigenf)) +
  facet_grid(~antigenf)+
  geom_point(alpha=0.7) +
  # geom_smooth(method="glm",color="gray40",lwd=0.5,se=FALSE) +
  geom_smooth(method="loess",color="gray40",lwd=0.5,se=FALSE) +
  geom_text(data=dfoicorr,
            aes(x=0.2,y=0.6,label=paste("rho ==",sprintf("%1.2f",corprev)) ),
            parse=TRUE,col="grey30") +
  scale_x_continuous(breaks=seq(0,1,by=0.2),labels=seq(0,100,by=20))+
  scale_color_manual(values=pcols)+
  coord_cartesian(xlim=c(0,1),ylim=c(0,0.7)) +
  labs(x="vid seroprevalence (%)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="none")
pfoivprev


pfoivprev2 <- ggplot(data=filter(d_foi,antigenf == "S. mansoni SEA"),aes(x=prevroc,y=lambda,color=arm)) +
  geom_point(alpha=0.7) +
  # geom_smooth(method="glm",color="gray40",lwd=0.5,se=FALSE) +
  geom_smooth(method="loess",color="gray40",lwd=0.5,se=FALSE) +
  geom_text(data=filter(dfoicorr,antigenf == "S. mansoni SEA"),
            aes(x=0.2,y=0.6,label=paste("rho ==",sprintf("%1.2f",corprev)) ),
            parse=TRUE,col="grey30") +
  scale_x_continuous(breaks=seq(0,1,by=0.2),labels=seq(0,100,by=20))+
  scale_color_manual(values=c(cblue,corange))+
  coord_cartesian(xlim=c(0,1),ylim=c(0,0.7)) +
  labs(x="vid seroprevalence (%)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="right")
pfoivprev2
# save png file for presentation
# ggsave(filename=here("output","mbita-foi-v-prev.png"),plot=pfoivprev,device="png",width=6,height=2.5)
```

## Downsample seroprevalence estimates
```{r community downsample}

# estimate means with sample sizes of betweeen 10 and 50 observations
set.seed(123)
ssests <- foreach(ssi=seq(200,20,by=-20),.combine=rbind) %:% 
  foreach(iteri=1:1000,.combine=rbind) %dopar% {
    di <- dl %>%
    group_by(community,antigenf) %>%
    sample_n(size=ssi,replace=TRUE) %>%
    summarize(meanmfi=mean(logmfi),
              seroprev=mean(seropos)) %>%
    mutate(ss=ssi,iter=iteri)
}

# merge in the means with the full sample
dlc2 <- dlc %>%
  select(community,antigenf,n,mean=meanmfi,serop=prevroc) %>%
  left_join(select(d_foi,community,antigenf,lambda),by=c("community","antigenf")) %>%
  mutate(antigenf=factor(antigenf,levels=levels(dl$antigenf)))
ssests2 <- left_join(ssests,dlc2,by=c("community","antigenf"))


# average over bootstrap estimates
ssmeans <- ssests2 %>%
  group_by(community,antigenf,ss) %>%
  summarize(mean=mean(mean),
            mu=mean(meanmfi),
            mu_sd=sd(meanmfi),
            mu_lb=quantile(meanmfi,probs=c(0.025)),
            mu_ub=quantile(meanmfi,probs=c(0.975)),
            mu_mse=mean((meanmfi-mean)^2),
            mu_bias=mean(meanmfi-mean),
            
            serop=mean(serop),
            prev=mean(seroprev),
            prev_sd=sd(seroprev),
            prev_lb=quantile(seroprev,probs=c(0.025)),
            prev_ub=quantile(seroprev,probs=c(0.975)),
            prev_mse=mean((seroprev-serop)^2),
            prev_bias=mean(seroprev-serop)
            )

# correlation betwen community-level means and seroprev, over bootstrap estimates
sscorr <- ssests2 %>%
  group_by(antigenf,ss,iter) %>%
  summarize(cor_mean=cor(meanmfi,serop,method="pearson"),
            cor_prev=cor(seroprev,serop,method="pearson")) %>%
  ungroup() %>%
  group_by(antigenf,ss) %>%
  summarize(cor_mu=mean(cor_mean),
            cor_mu_lb=quantile(cor_mean,probs=c(0.025)),
            cor_mu_ub=quantile(cor_mean,probs=c(0.975)),
            cor_pr=mean(cor_prev),
            cor_pr_lb=quantile(cor_prev,probs=c(0.025)),
            cor_pr_ub=quantile(cor_prev,probs=c(0.975)),
            )

# correlation betwen community-level means and FOI, over bootstrap estimates
sscorr_foi <- ssests2 %>%
  group_by(antigenf,ss,iter) %>%
  filter(!is.na(lambda)) %>%
  summarize(cor_mean=cor(meanmfi,lambda,method="spearman"),
            cor_prev=cor(seroprev,lambda,method="spearman")) %>%
  ungroup() %>%
  group_by(antigenf,ss) %>%
  summarize(cor_mu=mean(cor_mean),
            cor_mu_lb=quantile(cor_mean,probs=c(0.025)),
            cor_mu_ub=quantile(cor_mean,probs=c(0.975)),
            cor_pr=mean(cor_prev),
            cor_pr_lb=quantile(cor_prev,probs=c(0.025)),
            cor_pr_ub=quantile(cor_prev,probs=c(0.975)),
            )

```

Plot a figure of the correlation between the seroconversion rate estimated in the full sample versus cluster level mean (blue) or cluster level seroprevalence (orange) estimated at each smaller sample size

```{r downsample corr foi figure}
sscorfoip <- ggplot(data=filter(sscorr_foi,ss>=20),aes(x=ss,color=antigenf,fill=antigenf)) +
  facet_grid(.~antigenf)+
  # geom_ribbon(aes(ymin=cor_mu_lb,ymax=cor_mu_ub),color=NA,fill=cblue,alpha=0.2)+
  # geom_line(aes(y=cor_mu),color=cblue) +
  # geom_ribbon(aes(ymin=cor_pr_lb,ymax=cor_pr_ub),color=NA,alpha=0.2)+
  # geom_line(aes(y=cor_pr))+
  geom_pointrange(aes(y=cor_pr,ymin=cor_pr_lb,ymax=cor_pr_ub))+
  scale_fill_manual(values=pcols)+
  scale_color_manual(values=pcols)+
  scale_y_continuous(breaks=seq(0,1,by=0.2))+
  scale_x_continuous(breaks=seq(20,200,by=40))+
  coord_cartesian(ylim=c(0,1),xlim=c(20,200))+
  labs(y=expression(paste("correlation with FOI (",lambda,")")),x="sample size per community used to estimate seroprevalence") +
  theme_minimal()+
  theme(legend.position="none")
sscorfoip

# save png file for presentation
# ggsave(filename=here("output","mbita-foi-v-prev-downsample.png"),plot=sscorfoip,device="png",width=6,height=2.5)
```




Figure of results

```{r mfi and prev vs kk}

#  FOI vs KK geometric mean
pfoikkmean <- ggplot(data=dlckk,aes(x=meankk,color=antigenf)) +
  geom_point(aes(y=lambda),alpha=0.9) +
  geom_smooth(aes(y=lambda),method="glm",color="gray40",lwd=0.5,se=FALSE) +
  # geom_smooth(aes(y=lambda),method="loess",color="gray40",lwd=0.5,se=FALSE) +
  geom_text(data=dcorrkk,
            aes(x=0.1,y=0.65,label=paste("rho ==",sprintf("%1.2f",cormukkfoi)) ),
            parse=TRUE,col="grey30",hjust=0) +
  scale_y_continuous(breaks=seq(0,1,by=0.2))+
  scale_color_manual(values=pcols)+
  coord_cartesian(xlim=c(0,1.1),ylim=c(0,0.7)) +
  labs(x="community mean log10 eggs per gram",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="none")
pfoikkmean

pfoikkmean2 <- ggplot(data=dlckk,aes(x=meankk,color=arm)) +
  geom_point(aes(y=lambda),alpha=0.9) +
  geom_smooth(aes(y=lambda),method="glm",color="gray40",lwd=0.5,se=FALSE) +
  # geom_smooth(aes(y=lambda),method="loess",color="gray40",lwd=0.5,se=FALSE) +
  geom_text(data=dcorrkk,
            aes(x=0.1,y=0.65,label=paste("rho ==",sprintf("%1.2f",cormukkfoi)) ),
            parse=TRUE,col="grey30",hjust=0) +
  scale_y_continuous(breaks=seq(0,1,by=0.2))+
  scale_color_manual(values=c(cblue,corange))+
  coord_cartesian(xlim=c(0,1.1),ylim=c(0,0.7)) +
  labs(x="community mean log10 eggs per gram",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="right")
pfoikkmean2

# save png file for presentation
# ggsave(filename=here("output","mbita-foi-v-kkmean.png"),plot=pfoikkmean,device="png",width=4,height=4)

# # FOI vs KK prev
# pfoikkprev <- ggplot(data=dlckk,aes(x=prevkk,color=antigenf)) +
#   geom_point(aes(y=lambda),alpha=0.9) +
#   geom_smooth(aes(y=lambda),method="glm",color="gray40",lwd=0.5,se=FALSE) +
#   # geom_smooth(aes(y=lambda),method="loess",color="gray40",lwd=0.5,se=FALSE) +
#   geom_text(data=dcorrkk,
#             aes(x=0.1,y=0.65,label=paste("rho ==",sprintf("%1.2f",corpkkfoi)) ),
#             parse=TRUE,col="grey30",hjust=0) +
#   scale_y_continuous(breaks=seq(0,1,by=0.2))+
#   scale_x_continuous(breaks=seq(0,0.6,by=0.1),labels=sprintf("%1.0f",seq(0,0.6,by=0.1)*100))+
#   scale_color_manual(values=pcols)+
#   coord_cartesian(xlim=c(0,0.6),ylim=c(0,0.7)) +
#   labs(x="community prevalence, Kato-Katz (%)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
#   theme_minimal() +
#   theme(legend.position="none")
# pfoikkprev
# 
# # save png file for presentation
# # ggsave(filename=here("output","mbita-foi-v-kkprev.png"),plot=pfoikkprev,device="png",width=4,height=4)


```

# FOI versus distance from the lake

```{r foi vs dist}

dl2 <- dl %>%
  mutate(kkpos=ifelse(epg>0,1,0)) %>%
  filter(antigen=="sea")

fitdist <- mgcv::gam(seropos~s(mindist,bs="cr",k=4) + s(community,bs="re",by=dummy), 
                      data=filter(dl2,antigen=="sea"))
newd <- dl2 %>% filter(mindist<4000) %>% mutate(dummy=0)
fitdistci <- gamCI(m=fitdist,newdata=newd,nreps=10000)


# FOI vs KK prev
# pfoidist <- ggplot(data=dlckk,aes(x=mindist/1000,color=antigenf)) +
#   geom_point(aes(y=lambda),alpha=0.9) +
#   # geom_smooth(aes(y=lambda),method="glm",color="gray40",lwd=0.5,se=FALSE) +
#   geom_smooth(aes(y=lambda),method="loess",color="gray40",lwd=0.5,se=FALSE) +
#   scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
#   # scale_x_continuous(breaks=seq(0,0.6,by=0.1),labels=sprintf("%1.0f",seq(0,0.6,by=0.1)*100))+
#   scale_color_manual(values=pcols)+
#   # coord_cartesian(xlim=c(0,0.6),ylim=c(0,0.7)) +
#   labs(x="distance from lake Victoria (km)",y="community seroconversion rate per year") +
#   theme_minimal() +
#   theme(legend.position="none")
# pfoidist

pspdist <- ggplot(data=fitdistci,aes(x=mindist/1000)) +
  geom_point(data=dlckk,aes(x=mindist/1000,y=prevroc),alpha=0.9,color=cbblue) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")
pspdist

pspdist2 <- ggplot(data=fitdistci,aes(x=mindist/1000,color=arm)) +
  geom_point(data=dlckk,aes(x=mindist/1000,y=prevroc),alpha=0.9) +
  geom_line(aes(y=fit), color="gray40",lwd=0.3) +
  # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
  # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
  scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=c(cblue,corange))+
  coord_cartesian(ylim=c(0,0.9),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y="community seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="right")
pspdist2

# save png file for presentation
# ggsave(filename=here("output","mbita-prev-v-dist.png"),plot=pspdist,device="png",width=3*1.18,height=3)


pfoidist <- ggplot(data=dlckk,aes(x=mindist/1000,y=lambda)) +
  geom_point(alpha=0.9,color=cbblue) +
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  scale_x_continuous(breaks=0:5)+
  # scale_color_manual(values=pcols)+
  coord_cartesian(ylim=c(0,0.65),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="none")
pfoidist



pfoidist2 <- ggplot(data=dlckk,aes(x=mindist/1000,y=lambda,color=arm)) +
  geom_point(alpha=0.9) +
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  scale_x_continuous(breaks=0:5)+
  scale_color_manual(values=c(cblue,corange))+
  coord_cartesian(ylim=c(0,0.65),xlim=c(0,3.5)) +
  labs(x="distance from lake Victoria (km)",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  theme_minimal() +
  theme(legend.position="right")
pfoidist2

# save png file for presentation
# ggsave(filename=here("output","mbita-foi-v-dist.png"),plot=pfoidist,device="png",width=3*1.18,height=3)

# 
# # Repeat for Giardia (exploratory)
# dl3 <- dl %>%
#   filter(antigen=="vsp5")
# dl3m <- dl3 %>%
#   group_by(community,mindist) %>%
#   summarize(seroprev=mean(seropos))
# 
# fitdist2 <- mgcv::gam(seropos~s(mindist,bs="cr",k=4) + s(community,bs="re",by=dummy), 
#                       data=filter(dl3,antigen=="vsp5"))
# newd <- dl3 %>% filter(mindist<4000) %>% mutate(dummy=0)
# fitdistci2 <- gamCI(m=fitdist2,newdata=newd,nreps=10000)
# 
# pspdist2 <- ggplot(data=fitdistci2,aes(x=mindist/1000)) +
#   geom_point(data=dl3m,aes(x=mindist/1000,y=seroprev),alpha=0.9,color=cbpink) +
#   geom_line(aes(y=fit), color="gray40",lwd=0.3) +
#   # geom_ribbon(aes(ymin=lwrP,ymax=uprP),alpha=0.1,color=NA,fill="black") +
#   # geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.1,color=NA,fill="black") +
#   scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
#   scale_x_continuous(breaks=0:5)+
#   # scale_color_manual(values=pcols)+
#   coord_cartesian(ylim=c(0,1),xlim=c(0,3.5)) +
#   labs(x="distance from lake Victoria (km)",y="community seroprevalence (%)") +
#   theme_minimal() +
#   theme(legend.position="none")
# pspdist2

```

# FOI
Estimate marginal FOI for Schisto as well as conditional on distance from the lake

```{r foi simultaneous CI}

#----------------------------
# function to estimate the
# age-specific FOI under a
# GAM model smooth
#----------------------------
foiCI <- function(m,newdata,eps=1e-07,level=0.95,nreps=10000) {
  
  # variance-covariance matrix from the spline fit
  # unconditional on the fit of the mean
  # this is slightly more conservative and with better coverage
  # properties. 
  # See Marra G, Wood SN. 
  # Coverage Properties of Confidence Intervals 
  # for Generalized Additive Model Components.   
  # Scand Stat Theory Appl. 2012;39: 53–74.
  Vb <- vcov(m,unconditional = TRUE)
  
  # calculate the linear predictor, g(Ft), and its pointwise SE
  pred <- predict(m, newdata, se.fit = TRUE)
  Ft <- pred$fit
  Ft.se <- pred$se.fit
  
  # simulate from the posterior distrivbution
  # with mean zero and variance from the posterior
  # assuming multivariate normal coefficients
  BUdiff <- MASS::mvrnorm(n = nreps, mu = rep(0, nrow(Vb)), Sigma = Vb)
  
  # get a critical value for the
  # simultaneous confidence interval of g(Ft)
  X0 <- predict(m, newdata, type = "lpmatrix")
  Ft.simDev <- X0 %*% t(BUdiff)
  Ft.absDev <- abs(sweep(Ft.simDev, 1, Ft.se, FUN = "/"))
  Ft.masd <- apply(Ft.absDev, 2L, max)
  Ft.crit <- quantile(Ft.masd, prob = 0.95, type = 8)
  
  # calculate the derivative, g'(Ft), using
  # finite differences and its pointwise SE
  # ?mgcv::predict.gam includes an example of this
  newdata2 <- newdata+eps
  X1 <- predict(m,newdata2,type='lpmatrix')
  Xp <- (X1 - X0) / eps
  ft <- Xp %*% coef(m)
  ft.se <- rowSums(Xp %*% Vb * Xp)^0.5
  
  # get a critical value for the
  # simultaneous confidence interval of the derivative
  ft.simDev <- Xp %*% t(BUdiff)
  ft.absDev <- abs(sweep(ft.simDev, 1, ft.se, FUN = "/"))
  ft.masd <- apply(ft.absDev, 2L, max)
  ft.crit <- quantile(ft.masd, prob = level, type = 8)
  
  # parametric bootstrap simulation from the
  # model coefficient estimates, assuming the model is true
  # FOI is the derivative of the linear predictor
  # multiplied by the predicted probability, Ft
  sims<- MASS::mvrnorm(n = nreps, mu = coef(m), Sigma = Vb)
  Ft.bs <- X0 %*% t(sims)
  ft.bs <- Xp %*% t(sims)
  foi.bs <- ft.bs*(exp(Ft.bs)/(1+exp(Ft.bs)))
  
  # estimate age-specific force of infection
  # averaged over the bootstrap replicates
  # along with SE and confidence intervals for FOI
  # use whichever critical value is larger for Ft or ft
  # for the simultaneous CIs
  foi <- rowMeans(foi.bs)
  foi.crit <- max(Ft.crit,ft.crit)
  foi.se <- apply(foi.bs,1,function(x) sd(x))
  foi.ci <- t(apply(foi.bs,1,function(x) quantile(x,probs=c(0.025,0.975))) )
  foi.Sci <- cbind(foi - foi.crit*foi.se, foi + foi.crit*foi.se)
  
  # return objects
  list(foi=foi,foi.se=foi.se,foi.ci=foi.ci,foi.ciS=foi.Sci,Ft=Ft,Ft.se=Ft.se,Ft.crit=Ft.crit,ft=ft,ft.se=ft.se,ft.crit=ft.crit,model=m,data=newdata)
  
}
```

```{r est schisto foi}
#----------------------------
# estimate FOI for SEA
# from the spline model
#----------------------------

# fit a GAM model
# Schisto SEA
foid <- dl %>%
  filter(antigen=="sea") %>%
  mutate(dist15=ifelse(mindist>1500,1,0))

# marginal estimate
set.seed(123)
fitp_sea <- mgcv::gam(seropos~s(age,bs="cr",k=9), family="binomial", data=foid)
newd <- foid
fitp_seaci <- gamCI(m=fitp_sea,newdata=newd,nreps=10000)


# convert linear predictor to prevalance
expitfn <- function(x) {
  exp(x)/(1+exp(x))
}
fitp_seaci <- fitp_seaci %>%
  mutate(fit = expitfn(fit),
         uprP = expitfn(uprP),
         lwrP = expitfn(lwrP),
         uprS = expitfn(uprS),
         lwrS = expitfn(lwrS)
         )

foipcols <- cbPalette[c(2,3)]

# single, average estimate (assuming constant FOI)
seagfit <- glm(seropos~1,offset=log(age),data=foid,family=binomial(link="cloglog"))
  seagsum <- summary(seagfit)
  sea_lambda <- as.numeric(exp(seagfit$coefficients))
  log_lambda_se  <- sqrt(seagsum$cov.unscaled)
  sea_lambda_lb <- as.numeric(exp(seagfit$coefficients - 1.96*log_lambda_se))
  sea_lambda_ub <- as.numeric(exp(seagfit$coefficients + 1.96*log_lambda_se))

#----------------------------------------
# seroprevalence curve
#----------------------------------------
pageprev_sea <- ggplot(data=fitp_seaci,aes(x=age,y=fit)) +
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA,fill=pcols[1]) +
  geom_line(lwd=0.5,alpha=1,color=pcols[1]) +
  scale_y_continuous(breaks=seq(0,0.7,by=0.1),labels=seq(0,70,by=10))+
  coord_cartesian(ylim=c(0,0.7),xlim=c(0,5))+
  labs(x="age, years",y="seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")

pageprev_sea

# save png file for presentation
# ggsave(filename=here("output","mbita-sea-age-seroprev.png"),plot=pageprev_sea,device="png",width=3*1.18,height=3)

#----------------------------------------
# FOI curve
#----------------------------------------
# Model predictions of FOI, with age grid newd
set.seed(123)
newd <- data.frame(age=seq(0.2,5,by=0.01))
foi_ests <- foiCI(m=fitp_sea,newdata=newd)
foipd <- data.frame(age=foi_ests$data,foi=foi_ests$foi,foi_lb=foi_ests$foi.ciS[,1],foi_ub=foi_ests$foi.ciS[,2])

foiplot <- ggplot(data=foipd,aes(x=age,y=foi,ymin=foi_lb,ymax=foi_ub)) +
  geom_ribbon(color=NA,alpha=0.5,fill=pcols[1]) +
  geom_line(color=pcols[1]) +
  labs(x="age, years",y=expression(paste("age-specific hazard, ",lambda,"(a)")))+
  coord_cartesian(ylim=c(0,0.5))+
  theme_minimal()
foiplot

# save png file for presentation
# ggsave(filename=here("output","mbita-sea-age-foi.png"),plot=foiplot,device="png",width=3*1.18,height=3)

#----------------------------------------
# conditional estimates of seroprevalence
# for communities close vs. far from lake
#----------------------------------------
fitp_sea0 <- mgcv::gam(seropos~s(age,bs="cr",k=9), family="binomial", data=filter(foid,dist15==0))
fitp_sea1 <- mgcv::gam(seropos~s(age,bs="cr",k=9), family="binomial", data=filter(foid,dist15==1))


newd0 <- foid %>% mutate(dist15=0)
newd1 <- foid %>% mutate(dist15=1)
fitp_seaci0 <- gamCI(m=fitp_sea0,newdata=newd0,nreps=10000)
fitp_seaci1 <- gamCI(m=fitp_sea1,newdata=newd1,nreps=10000)

fitp_seaci01 <- bind_rows(fitp_seaci0,fitp_seaci1)
fitp_seaci01 <- fitp_seaci01 %>%
  mutate(fit = expitfn(fit),
         uprP = expitfn(uprP),
         lwrP = expitfn(lwrP),
         uprS = expitfn(uprS),
         lwrS = expitfn(lwrS)
         ) %>%
  mutate(dist=factor(dist15,levels=c(0,1),labels=c("<1.5 km from lake",">1.5 km from lake")))

#----------------------------------------
# seroprevalence curves
#----------------------------------------
pageprev_sea01 <- ggplot(data=fitp_seaci01,aes(x=age,y=fit,group=dist,color=dist,fill=dist)) +
  geom_ribbon(aes(ymin=lwrS,ymax=uprS),alpha=0.2,color=NA) +
  geom_line(lwd=0.5,alpha=1) +
  scale_color_manual(values=foipcols)+
  scale_fill_manual(values=foipcols)+
  scale_y_continuous(breaks=seq(0,0.8,by=0.1),labels=seq(0,80,by=10))+
  labs(x="age, years",y="seroprevalence (%)") +
  theme_minimal() +
  theme(legend.position="none")

pageprev_sea01

# save png file for presentation
# ggsave(filename=here("output","mbita-sea-age-seroprev-dist.png"),plot=pageprev_sea01,device="png",width=3*1.18,height=3)

#----------------------------------------
# Conditional estimates of FOI
#----------------------------------------
set.seed(123)
newd0 <- data.frame(age=seq(0.2,5,by=0.01),dist15=0)
newd1 <- data.frame(age=seq(0.2,5,by=0.01),dist15=1)
foi_ests0 <- foiCI(m=fitp_sea0,newdata=newd0)
foi_ests1 <- foiCI(m=fitp_sea1,newdata=newd1)

foipd0 <- data.frame(age=foi_ests0$data$age,foi=foi_ests0$foi,foi_lb=foi_ests0$foi.ciS[,1],foi_ub=foi_ests0$foi.ciS[,2],dist15=0)
foipd1 <- data.frame(age=foi_ests1$data$age,foi=foi_ests1$foi,foi_lb=foi_ests1$foi.ciS[,1],foi_ub=foi_ests1$foi.ciS[,2],dist15=1)
foipd01 <- bind_rows(foipd0,foipd1) %>%
  mutate(dist=factor(dist15,levels=c(0,1),labels=c("<1.5 km from lake",">1.5 km from lake")))

#----------------------------------------
# FOI curves
#----------------------------------------
foiplot2 <- ggplot(data=foipd01,aes(x=age,y=foi,ymin=foi_lb,ymax=foi_ub,group=dist,color=dist,fill=dist)) +
  geom_ribbon(color=NA,alpha=0.2) +
  geom_line() +
  scale_color_manual(values=foipcols)+
  scale_fill_manual(values=foipcols)+
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  labs(x="age, years",y=expression(paste("seroconversion rate per year (",lambda,")"))) +
  coord_cartesian(ylim=c(0,0.65))+
  theme_minimal() +
    theme(legend.position="none")
foiplot2

# save png file for presentation
# ggsave(filename=here("output","mbita-sea-age-foi-dist.png"),plot=foiplot2,device="png",width=3*1.18,height=3)

```

# Marginal average FOI from GAM model
Another way to estimate the average force of infection from the seroprevalence curve is to use the basic relationship between the hazard (force of infection) and the cumulative hazard. This ignores the distribution of age in the study population -- in this particular study, the age distriution is fairly uniform so this estimator should be very similar to the previous estimator that averages over the empirical age distribution.

The hazard or force of infection at age $a$ is: $\lambda(a) = F'(a)/(1-F(a))$. From the basic definition of the hazard rate, we have: 

$1- F(a) = \exp [ - \int_0^a \lambda(a) da ]$ and $\int_0^a \lambda(a) da = - \log [1-F(a)]$.

This is the cumulative hazard. The average hazard per month or year (units of $a$) also divided $-\log[1-F(a)]$ by $a$.  So, all of the information is embedded in the cumulative distribution function, $F(a)$, which here is the age-dependent seroprevalence curve. 

The average hazard over the age period $a_1=4$ to $a_2=17$ months is:

\begin{equation}
  \int_{a_1}^{a_2} \lambda(a) da = \frac{\log[1-F(a_1)]-\log[1-F(a_2)]}{a_2 - a_1}
\end{equation}

We estimate its variance from a parametric bootstrap simulation of the posterior distributions of the spline parameters (above).

```{r average foi}
avgFOI <- function(m,newdata,a1,a2,nreps=10000) {
  require(mgcv)
  require(dplyr)
  
  # limit the prediction data to the two time points
  newdata <- newdata %>%
    filter(age %in% c(a1,a2)) %>%
    arrange(age)
  
  # get predicted seroprevalence, Ft, from GAM model
  gFt <- predict(m, newdata)
  Ft <- exp(gFt)/(1+exp(gFt))
  
  # average FOI over a1 to a2 is: 
  # foi = [log(1-F(a1))-log(1-F(a2))] / (a2-a1)
  mufoi <- (log(1-Ft[1]) - log(1-Ft[2])) / (a2-a1) 

  # parametric bootstrap simulation from the
  # model coefficient estimates, assuming the model is true
  X0 <- predict(m, newdata, type = "lpmatrix")
  Vb <- vcov(m,unconditional = TRUE)
  sims<- MASS::mvrnorm(n = nreps, mu = coef(m), Sigma = Vb)
  gFt.bs <- X0 %*% t(sims)
  Ft.bs <- exp(gFt.bs)/(1+exp(gFt.bs))
  mufoi.bs <- (log(1-Ft.bs[1,]) - log(1-Ft.bs[2,])) / (a2-a1)
  
  # estimate approximate bs SE and percentile-based 95% credible interval
  mufoi.se <- sd(mufoi.bs)
  mufoi.ci <- quantile(mufoi.bs,probs=c(0.025,0.975))
  res <- data.frame(mufoi,mufoi_se=mufoi.se,mufoi_lb=mufoi.ci[1],mufoi_ub=mufoi.ci[2])
  return(res)
}


# average FOI from the GAM model, estimated above
fitp_sea_foii <- avgFOI(m=fitp_sea,newdata=data.frame(age=seq(0,5,by=0.01)),a1=0,a2=5)
fitp_sea_foii

# average FOI estimated from the exponential survival model
cbind(sea_lambda,sea_lambda_lb,sea_lambda_ub)

```


