---
title: "Mbita Schistosomiasis study village level SEA vs Kato-Katz"
author: "Ben Arnold"
date: ""
output: 
  html_document:
    highlight: haddock
    theme: default
    code_folding: hide
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---


# Preamble
```{r preamble}
library(here)
here()
#--------------------------------
# source the configuration file
#--------------------------------
source(here("R/mbita-schisto-Config.R"))
```


# Load and process data
```{r load data,message=FALSE,warning=FALSE}


#---------------------------
# mbita PSAC data
#---------------------------
d <- readRDS(here("data","mbita_schisto.rds") )

# create age strata
# create log values for SEA MFI and KK epg
# convert the dist_victoria variable from class units to numeric
d2 <- d %>%
  mutate(agecat = cut(agey,breaks=c(0,1,2,3,4,6),
                      labels=c("<1 year","1 year","2 years","3 years","4 years")),
         logsea = log10(sea),
         logepg = log10(sm_epg)         
         )

# create factor variables for modeling (used below)
d3 <- d2 %>% 
  ungroup() %>%
  mutate(vid=factor(vid),
         dummy=1)

#---------------------------
# collapse to counts at the
# village level, by year
# calculate prevalence
# by SEA and Kato-Katz
#
# also summarize by village
# over all years
#---------------------------

# summarized by village and year
dvil <- d3 %>%
  group_by(vid,year) %>%
  summarize(sea_n = sum(sea_pos,na.rm=T),
            sea_N = sum(ifelse(!is.na(sea_pos),1,0)),
            kk_n = sum(kk_pos,na.rm=T),
            kk_N = sum(ifelse(!is.na(kk_pos),1,0))
            ) %>%
  mutate(sea_prev = sea_n/sea_N,
         kk_prev = kk_n/kk_N,
         yearf = as.factor(year))

# summarized by village (over all years)
dvil2 <- d3 %>%
  group_by(vid) %>%
  summarize(sea_n = sum(sea_pos,na.rm=T),
            sea_N = sum(ifelse(!is.na(sea_pos),1,0)),
            kk_n = sum(kk_pos,na.rm=T),
            kk_N = sum(ifelse(!is.na(kk_pos),1,0))
            ) %>%
  mutate(sea_prev = sea_n/sea_N,
         kk_prev = kk_n/kk_N)

```


# Correlation between measures and over years

## Correlation between SEA and KK

Estimate the correlation between village-level SEA seroprevalence and Kato-Katz prevalence using a Spearman rank correlation statistic.  Estimate locally weighted smoothers of the relationship between SEA and Kato-Katz in each year and over all years.  Trim the smooths to 95% of the data to avoid edge effects.

```{r correlation between measures}

# estimate correlation overall
cor_sea_kk <- cor(dvil2$sea_prev,dvil2$kk_prev,method="spearman")
  

#--------------------------------
# estimate smooths, trimmed to
# drop the bottom and top 2.5% of
# data in each comparison
# to avoid edge effects
#--------------------------------
dsmooths <- foreach(yeari=levels(dvil$yearf),.combine=rbind) %do% {
                        pd <- filter(dvil,yearf==yeari)
                        xqs <- quantile(pd$kk_prev,probs=c(0.025,0.975),na.rm=TRUE)
                        yqs <- quantile(pd$sea_prev,probs=c(0.025,0.975),na.rm=TRUE)
                        newd <- data.frame(kk_prev=seq(xqs[1],xqs[2],by=0.01))
                        lfit <- loess(sea_prev~kk_prev,data=pd)
                        return(data.frame(yearf=yeari,
                                          kk_prev=newd$kk_prev,
                                          sea_prev=predict(lfit,newdata=newd))
                        )
                        }


pcols <- cbPalette[c(3,4,8)]

scatter_sea_kk <- ggplot(data=dvil,aes(x=kk_prev,y=sea_prev,color=yearf))+
  geom_abline(intercept=0,slope=1,color="gray40")+
  geom_line(data=dsmooths,size=0.5,alpha=0.5)+
  geom_point(alpha=0.8) +
  geom_smooth(data=dvil2,method="loess",se=FALSE,color="gray40",size=0.75)+
  scale_color_manual(values=pcols,guide=guide_legend(title="year")) +
  annotate("text",x=0.1,y=0.95,label=paste("rho ==",sprintf("%1.2f",cor_sea_kk)),parse=TRUE)+
  scale_y_continuous(breaks=seq(0,1,by=0.1),labels=sprintf("%1.0f",seq(0,1,by=0.1)*100))+
  scale_x_continuous(breaks=seq(0,1,by=0.1),labels=sprintf("%1.0f",seq(0,1,by=0.1)*100))+
  coord_cartesian(ylim=c(0,1),xlim=c(0,1))+
  labs(x="Kato-Katz prevalence (%)",y="SEA seroprevalence (%)")+
  theme(legend.position=c(0.9,0.2),
        panel.grid.minor=element_blank())
scatter_sea_kk

ggsave(filename = here("output","mbita-sea-kk-scatter.png"),plot = scatter_sea_kk, device = "png",width=4,height=4)

```

## Correlation between years for SEA and KK

Correlation between years for village-level SEA seroprevalence and Kato-Katz prevalence

```{r pairs plot of measure and year}

#--------------------------------
# custom pairs plot
# ggpairs() just too hard to 
# work with for this one
#--------------------------------
#--------------------------------
# spread the SEA and KK data
#--------------------------------
dvil_sea <- dvil %>%
  dplyr::select(vid,yearf,sea_prev) %>%
  spread(yearf,-vid) %>%
  rename(sea2012="2012",sea2013="2013",sea2014="2014")

dvil_kk <- dvil %>%
  dplyr::select(vid,yearf,kk_prev) %>%
  spread(yearf,-vid) %>%
  rename(kk2012="2012",kk2013="2013",kk2014="2014")

#--------------------------------
# x, y scatter plot function
# with correlation estimate
#--------------------------------
xypairs <- function(data,mapping,point_color) {
  # estimate correlation
  xycor <- cor(x=data[,gsub("~","",paste(mapping[1]))],
               y=data[,gsub("~","",paste(mapping[2]))],
               method="spearman")
  # plot the data
  ggplot(data = data, mapping = mapping)+
    geom_abline(intercept=0,slope=1,col="gray40")+
    geom_point(color=point_color,alpha=0.75)+
    annotate("text",x=0.25,y=0.9,label=paste("rho ==",sprintf("%1.2f",xycor)),parse=TRUE,color="gray40")+
    scale_y_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
    scale_x_continuous(breaks=seq(0,1,by=0.2),labels=sprintf("%1.0f",seq(0,1,by=0.2)*100))+
    coord_cartesian(xlim=c(0,1),ylim=c(0,1)) +
    labs(x="",y="") 
    # theme_minimal()
}

#--------------------------------
# make the panels
#--------------------------------
p1213 <- xypairs(data=dvil_sea,aes(x=sea2012,y=sea2013),point_color=cbPalette[3])
p1214 <- xypairs(data=dvil_sea,aes(x=sea2012,y=sea2014),point_color=cbPalette[3])
p1314 <- xypairs(data=dvil_sea,aes(x=sea2013,y=sea2014),point_color=cbPalette[3])
l2012 <- textGrob(label = "2012",x=unit(0.6,"npc"),y=unit(0.6,"npc"),gp=gpar(cex=1.4))
l2013 <- textGrob(label = "2013",x=unit(0.6,"npc"),y=unit(0.6,"npc"),gp=gpar(cex=1.4))
l2014 <- textGrob(label = "2014",x=unit(0.6,"npc"),y=unit(0.6,"npc"),gp=gpar(cex=1.4)) 
kk1213 <- xypairs(data=dvil_kk,aes(x=kk2012,y=kk2013),point_color=cbPalette[2])
kk1214 <- xypairs(data=dvil_kk,aes(x=kk2012,y=kk2014),point_color=cbPalette[2])
kk1314 <- xypairs(data=dvil_kk,aes(x=kk2013,y=kk2014),point_color=cbPalette[2])

#--------------------------------
# arrange the pairs plot
#--------------------------------
pairs_sea_kk <- grid.arrange(grobs = list(l2012,kk1213,kk1214,
                                       p1213,l2013,kk1314,
                                       p1214,p1314,l2014), 
                       widths = c(1,1,1), 
                       heights = c(1,1,1),
                       layout_matrix = matrix(1:9,ncol=3,nrow=3,byrow=TRUE),
                       left = textGrob(label="SEA seroprevalence (%)",y=0.4,x=0.5,rot=90),
                       bottom = textGrob(label="SEA seroprevalence (%)",y=0.5,x=0.4),
                       right = textGrob(label="Kato-Katz prevalence (%)",y=0.7,x=0.5,rot=270),
                       top = textGrob(label="Kato-Katz prevalence (%)",y=0.5,x=0.7)
                       )
ggsave(filename = here("output","mbita-sea-kk-year-prev-pairs.png"),plot = pairs_sea_kk, device = "png",width=6,height=6)

```

## Simplified version with only SEA

```{r pairs plot of SEA by year}

#--------------------------------
# make the panels
#--------------------------------
p1213 <- xypairs(data=dvil_sea,aes(x=sea2012,y=sea2013),point_color=cbPalette[3])
p1214 <- xypairs(data=dvil_sea,aes(x=sea2012,y=sea2014),point_color=cbPalette[3])
p1314 <- xypairs(data=dvil_sea,aes(x=sea2013,y=sea2014),point_color=cbPalette[3])
l2012 <- textGrob(label = "2012",x=unit(0.6,"npc"),y=unit(0.1,"npc"),gp=gpar(cex=1.4))
l2013 <- textGrob(label = "2013",x=unit(0.6,"npc"),y=unit(0.6,"npc"),gp=gpar(cex=1.4))
l2014 <- textGrob(label = "2014",x=unit(0.2,"npc"),y=unit(0.6,"npc"),gp=gpar(cex=1.4)) 

#--------------------------------
# arrange the pairs plot
#--------------------------------
pairs_sea <- grid.arrange(grobs = list(l2012,
                                       p1213,l2013,
                                       p1214,p1314,l2014), 
                       widths = c(1,1,1), 
                       heights = c(1,1,1),
                       layout_matrix = matrix(c(1,NA,NA,2,3,NA,4,5,6),nrow=3,ncol=3,byrow=T),
                       left = textGrob(label="SEA seroprevalence (%)",y=0.4,x=0.5,rot=90),
                       bottom = textGrob(label="SEA seroprevalence (%)",y=0.5,x=0.4),
                       # right = textGrob(label="Kato-Katz prevalence (%)",y=0.7,x=0.5,rot=270),
                       # top = textGrob(label="Kato-Katz prevalence (%)",y=0.5,x=0.7)
                       )
ggsave(filename = here("output","mbita-sea-year-prev-pairs.png"),plot = pairs_sea, device = "png",width=6,height=6)

```

# Compare village-level FOI and seroprevalence with KK


## Estimate village-level force of infection (FOI)
Estimate community-level FOI for pathogens based on the seroconversion rate (incidence among susceptibles). Assume a constant rate model (i.e., average over all ages).  If we assume a constant force of infection ($\lambda$), equivalent to assuming an exponential model, then it can be shown that a generalized linear model with a complementary log-log link fit with current status, age-prevalence data is equivalent to an exponential proportional hazards model (*Jewell and van der Laan 1995*). 

$\log - \log(1-P(Y|A,W)) = \log \lambda + \log A + \beta W$

Moroever, this model is also equivalent to a catalytic, SIR model with a single, constant rate parameter (*Hens et al. 2010*; *Hens et al. 2012*).

```{r  foi from exponential model}
foi_ests <- foreach(comi=levels(d3$vid),.combine=rbind) %dopar% {
  di <- d3 %>% filter(vid==comi)
  gfit <- glm(sea_pos~1,offset=log(agey),data=di,family=binomial(link="cloglog"))
  gsum <- summary(gfit)
  lambda <- as.numeric(exp(gfit$coefficients))
  log_lambda_se  <- sqrt(gsum$cov.unscaled)
  lambda_lb <- as.numeric(exp(gfit$coefficients - 1.96*log_lambda_se))
  lambda_ub <- as.numeric(exp(gfit$coefficients + 1.96*log_lambda_se))
  res <- data.frame(vid=comi,lambda,lambda_lb,lambda_ub)
  return(res)
}

foi_ests

```

## Comparison of village level estimates

```{r cluster means vs kk}

d3c <- d3 %>%
  group_by(vid) %>%
  mutate(nsea = ifelse(is.na(sea_pos),0,1),
         nkk = ifelse(is.na(kk_pos),0,1)
         ) %>%
  summarize(arm = max(arm),
            nsea = sum(nsea),
            meansea = mean(logsea),
            prevsea = mean(sea_pos),
            nkk = sum(nkk),
            meankk = mean(ifelse(logepg<0,1,logepg),na.rm=T),
            prevkk = mean(kk_pos,na.rm=T)
            )
             


# merge in FOI estimates
d3c <- d3c %>%
  left_join(foi_ests,by=c("vid"))

# # estimate pearson correlation
dcorrkk <- d3c %>%
  mutate(corspkk=cor(prevsea,prevkk,method="spearman"),
         cormukk=cor(meansea,prevkk,method="spearman"),
         corpseakkmu=cor(prevsea,meankk,method="spearman"),
         cormukkfoi=cor(lambda,meankk,method="spearman"),
         corpkkfoi=cor(lambda,prevkk,method="spearman")) %>%
  slice(1)


sp_epg_plot <- ggplot(data=d3c,aes(x=meankk,y=prevsea)) +
  geom_point(color=cbPalette[3],alpha=0.9) +
  geom_smooth(method="loess",se=FALSE,color="black",lwd=0.5) +
  scale_y_continuous(breaks=seq(0,1,by=0.1),labels=sprintf("%1.0f",seq(0,1,by=0.1)*100))+
  coord_cartesian(ylim=c(0,1),xlim=c(1.0,1.5))+
  labs(x="",y="SEA seroprevalence (%)") +
  theme(panel.grid.minor.y=element_blank())

foi_epg_plot <- ggplot(data=d3c,aes(x=meankk,y=lambda)) +
  geom_point(color=cbPalette[3],alpha=0.9) +
  geom_smooth(method="loess",se=FALSE,color="gray40",lwd=0.25) +
  geom_smooth(method="glm",se=FALSE,color="black",lwd=0.5) +
  scale_y_continuous(breaks=seq(0,0.6,by=0.1))+
  coord_cartesian(ylim=c(0,0.65),xlim=c(1.0,1.5))+
  labs(x="mean log10 S. mansoni eggs per gram",y=expression(paste("force of infection (",lambda,"), seroconversion rate per year")) ,eval=TRUE)


vil_trans_plots <- grid.arrange(sp_epg_plot,foi_epg_plot,nrow=2,ncol=1)

ggsave(filename=here("output","mbita-village-transmission-ests.png"),plot=vil_trans_plots,device="png",width=4,height=8)

```

# Session Info
```{r session info}
sessionInfo()
```
